{% extends "base.html" %}

{% block title %}{{ budget.name }} - OrÃ§amentos{% endblock %}
{% block page_title %}Detalhes do OrÃ§amento{% endblock %}

{% block content %}
{% include 'components/breadcrumbs.html' %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Budget Info Card -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">{{ budget.name }}</h2>
                    <p class="text-sm text-gray-500 mt-1">Criado em {{ budget.created_at|date:"d/m/Y" }}</p>
                </div>

                <div class="flex gap-2">
                    <a href="{% url 'budgets:edit' budget.pk %}"
                        class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all">
                        Editar
                    </a>
                    <button onclick="openBudgetDeleteModal({{ budget.pk }}, '{{ budget.name|escapejs }}', '{{ budget.proposal.title|escapejs }}', {{ budget.items.count }})"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all">
                        Excluir
                    </button>
                </div>
            </div>

            <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <dt class="text-sm font-medium text-gray-500">Proposta</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        <a href="{% url 'projects:detail' budget.proposal.pk %}" class="text-blue-600 hover:underline">
                            {{ budget.proposal.title }}
                        </a>
                    </dd>
                </div>

                <div>
                    <dt class="text-sm font-medium text-gray-500">Evento</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        <a href="{% url 'events:detail' budget.proposal.event.pk %}" class="text-blue-600 hover:underline">
                            {{ budget.proposal.event.name }}
                        </a>
                    </dd>
                </div>

                <div>
                    <dt class="text-sm font-medium text-gray-500">Status</dt>
                    <dd class="mt-1">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if budget.status == 'approved' %}bg-green-100 text-green-800
                            {% elif budget.status == 'rejected' %}bg-red-100 text-red-800
                            {% elif budget.status == 'sent' %}bg-blue-100 text-blue-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ budget.get_status_display }}
                        </span>
                    </dd>
                </div>

                <div>
                    <dt class="text-sm font-medium text-gray-500">Selecionado</dt>
                    <dd class="mt-1 text-sm text-gray-900">
                        {% if budget.is_selected %}
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-purple-100 text-purple-800">
                            Sim
                        </span>
                        {% else %}
                        NÃ£o
                        {% endif %}
                    </dd>
                </div>

                <div class="md:col-span-2">
                    <dt class="text-sm font-medium text-gray-500">Valor Total dos Itens</dt>
                    <dd class="mt-1 text-2xl font-bold text-gray-900">R$ {{ budget.total_value|floatformat:2 }}</dd>
                </div>
                {% if budget.freight_cost %}
                <div class="md:col-span-2">
                    <dt class="text-sm font-medium text-gray-500">Total com LogÃ­stica / Frete</dt>
                    <dd class="mt-1 text-2xl font-bold text-black">R$ {{ budget.total_with_freight|floatformat:2 }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>

        <!-- Approval Link Section -->
        <div class="bg-gradient-to-r from-black to-gray-800 rounded-lg shadow-sm p-6 mt-6">
            <div class="flex items-start justify-between">
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-white mb-2">ðŸ”— Link de AprovaÃ§Ã£o do Cliente</h3>
                    <p class="text-gray-300 text-sm mb-4">Compartilhe este link com o cliente para aprovaÃ§Ã£o do orÃ§amento</p>
                    
                    <div class="flex items-center gap-2 mb-3">
                        <input type="text" readonly 
                            id="approval-link"
                            value="{{ request.scheme }}://{{ request.get_host }}{% url 'budgets:public_approval' budget.approval_token %}"
                            class="flex-1 px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm text-gray-900 focus:ring-2 focus:ring-white">
                        <button onclick="copyApprovalLink()" 
                            class="px-4 py-2 bg-white text-black rounded-lg hover:bg-gray-100 transition-all font-medium text-sm">
                            ðŸ“‹ Copiar
                        </button>
                    </div>
                    
                    <div class="flex gap-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium
                            {% if budget.approval_status == 'approved' %}bg-green-500 text-white
                            {% elif budget.approval_status == 'rejected' %}bg-red-500 text-white
                            {% else %}bg-yellow-500 text-black{% endif %}">
                            {{ budget.get_approval_status_display }}
                        </span>
                        {% if budget.approved_at %}
                        <span class="text-xs text-gray-300">
                            Processado em {{ budget.approved_at|date:"d/m/Y H:i" }}
                        </span>
                        {% endif %}
                    </div>
                    
                    {% if budget.approval_status == 'approved' %}
                    <div class="mt-3 p-3 bg-green-900 bg-opacity-30 border border-green-500 rounded-lg">
                        <p class="text-sm text-green-100">
                            <strong>Valor Aprovado:</strong> R$ {{ budget.approved_value|floatformat:2 }}
                        </p>
                    </div>
                    {% endif %}
                    
                    {% if budget.client_notes %}
                    <div class="mt-3 p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg">
                        <p class="text-xs text-gray-400 mb-1">ObservaÃ§Ãµes do Cliente:</p>
                        <p class="text-sm text-white">{{ budget.client_notes }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Budget Items Section -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Itens do OrÃ§amento</h3>
            </div>

            {% if budget.items.all %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Qtd</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">DimensÃµes (m)</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Vol. unit. (mÂ³)</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Peso unit. (kg)</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Valor Unit.</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for item in budget.items.all %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-900">
                                {{ item.name }}
                                {% if item.description %}
                                <p class="text-xs text-gray-500">{{ item.description }}</p>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900 text-right">{{ item.quantity }}</td>
                            <td class="px-4 py-3 text-xs text-gray-500 text-right">
                                {% if item.dim_length and item.dim_width and item.dim_height %}
                                    {{ item.dim_length }} Ã— {{ item.dim_width }} Ã— {{ item.dim_height }}
                                {% else %}
                                    â€“
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-right {% if item.measurement and item.measurement_unit == 'm3' %}text-blue-600 font-medium{% else %}text-gray-400{% endif %}">
                                {% if item.measurement and item.measurement_unit == 'm3' %}
                                    {{ item.measurement|floatformat:3 }}
                                {% else %}
                                    â€“
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-xs text-right {% if item.weight %}text-blue-600 font-medium{% else %}text-gray-400{% endif %}">
                                {% if item.weight %}{{ item.weight|floatformat:3 }}{% else %}â€“{% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900 text-right">R$ {{ item.unit_price|floatformat:2 }}</td>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900 text-right">R$ {{ item.total_price|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-gray-50">
                        <!-- Consolidated logistics row -->
                        {% with wt=budget.total_weight vl=budget.total_volume %}
                        {% if wt or vl %}
                        <tr class="border-t border-blue-100 bg-blue-50">
                            <td colspan="7" class="px-4 py-2 text-xs text-blue-700">
                                <span class="font-semibold">Totais consolidados para frete:</span>
                                {% if wt %}
                                &nbsp;Peso total: <strong>{{ wt|floatformat:3 }} kg</strong>
                                {% endif %}
                                {% if vl %}
                                &nbsp;|&nbsp; Volume total: <strong>{{ vl|floatformat:3 }} mÂ³</strong>
                                {% endif %}
                                <span class="text-blue-400 ml-2">(faixas aplicadas ao total consolidado de todos os itens)</span>
                            </td>
                        </tr>
                        {% endif %}
                        {% endwith %}
                        <tr>
                            <td colspan="6" class="px-4 py-3 text-sm font-semibold text-gray-900 text-right">Subtotal dos Itens:</td>
                            <td class="px-4 py-3 text-sm font-bold text-gray-900 text-right">R$ {{ budget.total_value|floatformat:2 }}</td>
                        </tr>
                        {% if budget.freight_cost %}
                        <tr class="border-t-2 border-gray-300">
                            <td colspan="6" class="px-4 py-3 text-sm text-gray-600 text-right">
                                LogÃ­stica / Frete
                                {% if budget.freight_urgency %}
                                <span class="ml-1 px-1.5 py-0.5 text-xs bg-gray-100 rounded">{{ budget.freight_urgency.label }} Ã—{{ budget.freight_urgency.multiplier }}</span>
                                {% endif %}
                                {% if budget.freight_distance_km %}
                                <span class="ml-1 text-xs text-gray-400">â€“  {{ budget.freight_distance_km }} km</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700 font-medium text-right">R$ {{ budget.freight_cost|floatformat:2 }}</td>
                        </tr>
                        <tr class="bg-black">
                            <td colspan="6" class="px-4 py-3 text-sm font-bold text-white text-right">Total com Frete:</td>
                            <td class="px-4 py-3 text-sm font-bold text-white text-right">R$ {{ budget.total_with_freight|floatformat:2 }}</td>
                        </tr>
                        {% endif %}
                    </tfoot>
                </table>
            </div>
            {% else %}
            <p class="text-sm text-gray-500 text-center py-4">Nenhum item cadastrado</p>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Freight Calculator Card -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-1 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                </svg>
                LogÃ­stica e Frete
            </h3>
            {% if budget.freight_cost %}
            <div class="mt-3 p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm space-y-1">
                <div class="flex justify-between">
                    <span class="text-gray-500">Custo de frete</span>
                    <span class="font-medium text-gray-900">R$ {{ budget.freight_cost|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-500">UrgÃªncia</span>
                    <span class="text-gray-700">{{ budget.freight_urgency.label|default:"-" }}</span>
                </div>
                {% if budget.freight_distance_km %}
                <div class="flex justify-between">
                    <span class="text-gray-500">DistÃ¢ncia</span>
                    <span class="text-gray-700">{{ budget.freight_distance_km }} km</span>
                </div>
                {% endif %}
                <div class="flex justify-between border-t border-gray-200 pt-1 mt-1">
                    <span class="font-semibold text-gray-900">Total c/ frete</span>
                    <span class="font-bold text-gray-900">R$ {{ budget.total_with_freight|floatformat:2 }}</span>
                </div>
            </div>
            {% endif %}

            <!-- Quick Calculate form -->
            <form id="freight-form"
                  action="{% url 'budgets:calculate-freight' budget.pk %}"
                  method="post" class="mt-4 space-y-3">
                {% csrf_token %}
                <input type="hidden" name="save" value="1">

                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">UrgÃªncia</label>
                    <select name="urgency_id"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                        <option value="">â€“ Selecione â€“</option>
                        {% for um in urgency_options %}
                        <option value="{{ um.pk }}"
                            {% if budget.freight_urgency_id == um.pk %}selected{% endif %}
                            {% if not budget.freight_urgency_id and um.is_default %}selected{% endif %}>
                            {{ um.label }} (Ã—{{ um.multiplier }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">DistÃ¢ncia (km) â€“ opcional</label>
                    <input type="number" name="distance_km" step="0.1" min="0"
                        value="{{ budget.freight_distance_km|default:'' }}"
                        placeholder="0.00"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-black focus:border-transparent">
                </div>

                <button type="submit"
                    class="w-full px-4 py-2 bg-black text-white text-sm font-medium rounded-lg hover:bg-gray-800 transition-colors">
                    Calcular e Salvar Frete
                </button>
            </form>

            <div class="mt-3 text-right">
                <a href="{% url 'logistics:config' %}"
                    class="text-xs text-gray-400 hover:text-black hover:underline transition-colors">
                    Configurar tabelas de frete â†’
                </a>
            </div>
        </div>

        <!-- Metadata -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">InformaÃ§Ãµes</h3>
            <dl class="space-y-3">
                <div>
                    <dt class="text-xs text-gray-500">Criado por</dt>
                    <dd class="text-sm text-gray-900">
                        {% if budget.created_by %}
                            {{ budget.created_by.get_full_name|default:budget.created_by.username }}
                        {% else %}â€”{% endif %}
                    </dd>
                </div>
                <div>
                    <dt class="text-xs text-gray-500">Criado em</dt>
                    <dd class="text-sm text-gray-900">{{ budget.created_at|date:"d/m/Y H:i" }}</dd>
                </div>
                {% if budget.updated_by %}
                <div>
                    <dt class="text-xs text-gray-500">Ãšltima atualizaÃ§Ã£o</dt>
                    <dd class="text-sm text-gray-900">{{ budget.updated_at|date:"d/m/Y H:i" }}</dd>
                </div>
                {% endif %}
            </dl>
        </div>

        <!-- Service Order -->
        {% if budget.service_order %}
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Ordem de ServiÃ§o</h3>
            <a href="{% url 'service_orders:detail' budget.service_order.pk %}" class="text-blue-600 hover:underline">
                OS #{{ budget.service_order.pk }} - {{ budget.service_order.get_status_display }}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Delete Modal -->
{% include 'components/delete_modal.html' %}

{% csrf_token %}

<script>
function openBudgetDeleteModal(budgetId, budgetName, proposalTitle, itemsCount) {
    const deleteUrl = `/budgets/${budgetId}/delete/`;
    const redirectUrl = '{% url "budgets:list" %}';
    
    const itemDetails = `
        <div class="space-y-2">
            <p class="text-sm font-medium text-gray-900">${budgetName}</p>
            <p class="text-sm text-gray-500">Proposta: ${proposalTitle}</p>
        </div>
    `;
    
    const warning = itemsCount > 0 
        ? `Este orÃ§amento possui ${itemsCount} item${itemsCount > 1 ? 'ns' : ''} associado${itemsCount > 1 ? 's' : ''}.`
        : null;
    
    openDeleteModal(deleteUrl, `o orÃ§amento "${budgetName}"`, itemDetails, warning, redirectUrl);
}

function copyApprovalLink() {
    const linkInput = document.getElementById('approval-link');
    linkInput.select();
    linkInput.setSelectionRange(0, 99999); // For mobile devices
    
    navigator.clipboard.writeText(linkInput.value).then(function() {
        // Show success message
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = 'âœ… Copiado!';
        button.classList.add('bg-green-500', 'text-white');
        button.classList.remove('bg-white', 'text-black');
        
        setTimeout(function() {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-500', 'text-white');
            button.classList.add('bg-white', 'text-black');
        }, 2000);
    }, function(err) {
        console.error('Erro ao copiar:', err);
        alert('Erro ao copiar o link. Por favor, copie manualmente.');
    });
}
</script>
{% endblock %}
