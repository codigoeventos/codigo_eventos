{% extends "base.html" %}

{% block title %}{{ form_title }} - Empreiteiras{% endblock %}
{% block page_title %}{{ form_title }}{% endblock %}

{% block content %}
{% include 'components/breadcrumbs.html' %}

<div class="w-full mx-auto">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 w-full">
        <form method="post" novalidate>
            {% csrf_token %}
            {% include 'components/form_errors.html' %}

            <div class="space-y-8">

                <!-- Identificação -->
                <div>
                    <h3 class="text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Identificação</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.name.label }} *</label>
                            {{ form.name }}
                            {% if form.name.errors %}<p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.trade_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.trade_name.label }}</label>
                            {{ form.trade_name }}
                            {% if form.trade_name.errors %}<p class="mt-1 text-sm text-red-600">{{ form.trade_name.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.cnpj.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.cnpj.label }}</label>
                            {{ form.cnpj }}
                            {% if form.cnpj.errors %}<p class="mt-1 text-sm text-red-600">{{ form.cnpj.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.state_registration.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.state_registration.label }}</label>
                            {{ form.state_registration }}
                            {% if form.state_registration.errors %}<p class="mt-1 text-sm text-red-600">{{ form.state_registration.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.legal_representative.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.legal_representative.label }}</label>
                            {{ form.legal_representative }}
                            {% if form.legal_representative.errors %}<p class="mt-1 text-sm text-red-600">{{ form.legal_representative.errors.0 }}</p>{% endif %}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.notes.label }}</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>

                <!-- Contato -->
                <div>
                    <h3 class="text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Contato</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.phone.label }}</label>
                            {{ form.phone }}
                            {% if form.phone.errors %}<p class="mt-1 text-sm text-red-600">{{ form.phone.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.email.label }}</label>
                            {{ form.email }}
                            {% if form.email.errors %}<p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>{% endif %}
                        </div>
                        <div>
                            <label for="{{ form.website.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.website.label }}</label>
                            {{ form.website }}
                            {% if form.website.errors %}<p class="mt-1 text-sm text-red-600">{{ form.website.errors.0 }}</p>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Endereço -->
                <div>
                    <h3 class="text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Endereço</h3>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-6">
                        <div class="md:col-span-4">
                            <label for="{{ form.address_street.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.address_street.label }}</label>
                            {{ form.address_street }}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.address_number.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.address_number.label }}</label>
                            {{ form.address_number }}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.address_complement.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.address_complement.label }}</label>
                            {{ form.address_complement }}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.address_neighborhood.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.address_neighborhood.label }}</label>
                            {{ form.address_neighborhood }}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.address_zip.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.address_zip.label }}</label>
                            {{ form.address_zip }}
                        </div>
                        <div class="md:col-span-4">
                            <label for="{{ form.address_city.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.address_city.label }}</label>
                            {{ form.address_city }}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.address_state.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.address_state.label }}</label>
                            {{ form.address_state }}
                        </div>
                    </div>
                </div>

                <!-- Dados Bancários -->
                <div>
                    <h3 class="text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Dados Bancários</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="{{ form.bank_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.bank_name.label }}</label>
                            {{ form.bank_name }}
                        </div>
                        <div>
                            <label for="{{ form.bank_agency.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.bank_agency.label }}</label>
                            {{ form.bank_agency }}
                        </div>
                        <div>
                            <label for="{{ form.bank_account.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.bank_account.label }}</label>
                            {{ form.bank_account }}
                        </div>
                        <div>
                            <label for="{{ form.bank_account_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.bank_account_type.label }}</label>
                            {{ form.bank_account_type }}
                        </div>
                        <div class="md:col-span-2">
                            <label for="{{ form.bank_pix_key.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.bank_pix_key.label }}</label>
                            {{ form.bank_pix_key }}
                        </div>
                    </div>
                </div>

                <!-- Documentação -->
                <div>
                    <h3 class="text-base font-semibold text-gray-900 mb-4 pb-2 border-b border-gray-200">Documentação</h3>
                    <div>
                        <label for="{{ form.certifications.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">{{ form.certifications.label }}</label>
                        {{ form.certifications }}
                        <p class="mt-1 text-xs text-gray-400">{{ form.certifications.help_text }}</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex justify-end gap-3">
                <a href="{% if object %}{% url 'contractors:detail' object.pk %}{% else %}{% url 'contractors:list' %}{% endif %}"
                    class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all">
                    Cancelar
                </a>
                <button type="submit" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800 transition-all">
                    {{ submit_text }}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CNPJ Auto-fill
document.addEventListener('DOMContentLoaded', function() {
    const cnpjInput = document.getElementById('id_cnpj');
    if (!cnpjInput) return;

    let debounceTimer;
    let lastFetchedCNPJ = '';

    cnpjInput.addEventListener('blur', function() {
        const cnpj = this.value.trim();
        const cleanCNPJ = cnpj.replace(/\D/g, '');
        
        // Verifica se é um CNPJ válido (14 dígitos) e se ainda não foi consultado
        if (cleanCNPJ.length === 14 && cleanCNPJ !== lastFetchedCNPJ) {
            fetchCNPJData(cnpj);
        }
    });

    function fetchCNPJData(cnpj) {
        const cleanCNPJ = cnpj.replace(/\D/g, '');
        lastFetchedCNPJ = cleanCNPJ;

        // Mostra loading
        cnpjInput.style.backgroundColor = '#f3f4f6';
        cnpjInput.disabled = true;

        fetch(`{% url 'contractors:cnpj_lookup' %}?cnpj=${encodeURIComponent(cnpj)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.data) {
                    // Preenche os campos apenas se estiverem vazios
                    fillFieldIfEmpty('id_name', data.data.name);
                    fillFieldIfEmpty('id_trade_name', data.data.trade_name);
                    fillFieldIfEmpty('id_phone', data.data.phone);
                    fillFieldIfEmpty('id_email', data.data.email);
                    fillFieldIfEmpty('id_address_street', data.data.address_street);
                    fillFieldIfEmpty('id_address_number', data.data.address_number);
                    fillFieldIfEmpty('id_address_complement', data.data.address_complement);
                    fillFieldIfEmpty('id_address_neighborhood', data.data.address_neighborhood);
                    fillFieldIfEmpty('id_address_city', data.data.address_city);
                    fillFieldIfEmpty('id_address_state', data.data.address_state);
                    fillFieldIfEmpty('id_address_zip', data.data.address_zip);

                    // Mostra mensagem de sucesso
                    showNotification('Dados preenchidos com base no CNPJ!', 'success');
                } else {
                    showNotification(data.error || 'Não foi possível consultar o CNPJ', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao consultar CNPJ:', error);
                showNotification('Erro ao consultar CNPJ. Tente novamente.', 'error');
            })
            .finally(() => {
                cnpjInput.style.backgroundColor = '';
                cnpjInput.disabled = false;
            });
    }

    function fillFieldIfEmpty(fieldId, value) {
        const field = document.getElementById(fieldId);
        if (field && !field.value && value) {
            field.value = value;
            // Adiciona animação de destaque
            field.style.transition = 'background-color 0.5s';
            field.style.backgroundColor = '#d1fae5';
            setTimeout(() => {
                field.style.backgroundColor = '';
            }, 1500);
        }
    }

    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white z-50 ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.transition = 'opacity 0.5s';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }
});
</script>
{% endblock %}
